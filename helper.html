<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NeedsConnect ‑ Helper Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #f9f9f9;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 img {
      height: 40px;
    }

    header .header-buttons {
      display: flex;
      gap: 10px;
    }

    header button {
      background: #007f6b;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    header button:hover { background: #005e4b; }

    .container { padding: 30px 40px; flex: 1; }

    .category-menu {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .category-menu button {
      background: #007f6b;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .category-menu button.active, .category-menu button:hover { background: #005e4b; }

    .needs-top {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
    }

    .main-need {
      flex: 2;
      position: relative;
      cursor: pointer;
      height: 400px;
    }

    .main-need img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }

    .main-need .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.4);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 0 0 10px 10px;
      font-size: 18px;
    }

    .main-need:hover .overlay { opacity: 1; }

    .main-need .overlay button {
      background: #00a86b;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      font-size: 16px;
    }

    .other-needs {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 200px);
      gap: 10px;
      position: relative;
    }

    .other-needs .need-card {
      position: relative;
      cursor: pointer;
      height: 100%;
    }

    .other-needs .need-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }

    .other-needs .need-card .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.4);
      color: white;
      padding: 8px;
      opacity: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: opacity 0.3s;
      border-radius: 0 0 10px 10px;
      font-size: 14px;
    }

    .other-needs .need-card:hover .overlay { opacity: 1; }

    .view-more-btn {
      position: absolute;
      right: -5px;
      bottom: 0;
      width: 40px;
      height: 100%;
      background: rgba(0,0,0,0.3);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: pointer;
      border-radius: 0 10px 10px 0;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* Donation modal */
    .donation-modal {
      position: fixed;
      top: 50%;
      right: -400px;
      transform: translateY(-50%);
      width: 350px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 20px;
      transition: right 0.3s ease;
      z-index: 200;
    }

    .donation-modal.active { right: 20px; }

    .donation-modal h3 { margin-top: 0; font-size: 20px; }

    .donation-modal label { display: block; margin-top: 10px; font-weight: 500; }

    .donation-modal input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }

    .donation-modal .preset-btns button {
      margin: 5px 5px 0 0; padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; background: #00a86b; color: white; transition: 0.2s;
    }

    .donation-modal .preset-btns button:hover { background: #007f6b; }

    .donation-modal button.confirm { margin-top: 15px; width: 100%; background: #00a86b; color: white; padding: 10px; border-radius: 5px; cursor: pointer; }

    /* Basket modal */
    .basket-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 20px;
      display: none;
      z-index: 300;
    }

    .basket-modal.active { display: block; }

    .basket-modal h3 {
      margin-top: 0;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .basket-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }

    .basket-list div { display: flex; justify-content: space-between; margin-bottom: 8px; }

    .basket-subtotal { font-weight: bold; margin-top: 10px; }

    .basket-modal button.checkout {
      margin-top: 10px;
      width: 100%;
      background: #00a86b;
      color: white;
      padding: 10px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .basket-modal button.checkout:hover { background: #007f6b; }

    footer { background: #005e4b; color: #f9f9f9; text-align: center; padding: 20px 0; font-size: 14px; }
  </style>
</head>
<body>

<header>
  <h1><img src="Logo.jpg" alt="NeedsConnect Logo"></h1>
  <div class="header-buttons">
    <button onclick="openBasket()">View Basket</button>
    <button onclick="location.href='request.html'">Request Need</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <div class="category-menu" id="categoryMenu"></div>
  <div class="needs-top">
    <div class="main-need" id="mainNeed"></div>
    <div class="other-needs" id="otherNeeds"></div>
  </div>
</div>

<footer>© 2025 NeedsConnect | Empowering Communities</footer>

<!-- Donation modal -->
<div class="donation-modal" id="donationModal">
  <h3 id="donationTitle">Donate</h3>
  <label>Select Amount:</label>
  <div class="preset-btns">
    <button onclick="setAmount(5)">$5</button>
    <button onclick="setAmount(10)">$10</button>
    <button onclick="setAmount(20)">$20</button>
  </div>
  <label>Or custom amount:</label>
  <input type="number" id="customAmount" min="1" max="1000" placeholder="Max $1000">
  <button class="confirm" onclick="confirmDonation()">Add to Basket</button>
</div>

<!-- Basket modal -->
<div class="basket-modal" id="basketModal">
  <h3>
    Your Basket
    <span style="cursor:pointer;" onclick="closeBasket()">✖</span>
  </h3>
  <div class="basket-list" id="basketList"></div>
  <div class="basket-subtotal" id="basketSubtotal">Subtotal: $0</div>
  <button class="checkout" onclick="checkoutBasket()">Checkout</button>
</div>

<script>
if (!localStorage.getItem("user")) window.location.href = "login.html";

let allNeeds = [];
let activeCategory = null;
let basket = [];
let currentNeed = null;

const mainNeedDiv = document.getElementById("mainNeed");
const otherNeedsDiv = document.getElementById("otherNeeds");
const categoryMenuDiv = document.getElementById("categoryMenu");
const donationModal = document.getElementById("donationModal");
const donationTitle = document.getElementById("donationTitle");
const customAmount = document.getElementById("customAmount");
const basketModal = document.getElementById("basketModal");
const basketList = document.getElementById("basketList");
const basketSubtotal = document.getElementById("basketSubtotal");

async function loadNeeds() {
  try {
    const res = await fetch("http://localhost:5000/api/needs");
    allNeeds = await res.json();
    const categories = [...new Set(allNeeds.map(n => n.category))];
    activeCategory = categories[0] || null;
    renderCategories(categories);
    renderNeeds();
  } catch (err) {
    console.error(err);
  }
}

function renderCategories(categories){
  categoryMenuDiv.innerHTML = "";
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    if(cat===activeCategory) btn.classList.add("active");
    btn.onclick = () => { activeCategory = cat; renderNeeds(); renderCategories(categories); };
    categoryMenuDiv.appendChild(btn);
  });
}

function renderNeeds() {
  if(!activeCategory) return;
  const needs = allNeeds.filter(n => n.category===activeCategory);
  if(needs.length===0){ mainNeedDiv.innerHTML="<p>No needs available.</p>"; otherNeedsDiv.innerHTML=""; return; }

  const first = needs[0];
  mainNeedDiv.innerHTML=`
    <img src="${first.image_url}" alt="${first.name}">
    <div class="overlay">
      <span>${first.name} — $${first.amount_needed}</span>
      <button ${first.amount_needed<=0?"disabled":""} onclick="openDonation(${first.id}, '${first.name}', ${first.amount_needed})">
        ${first.amount_needed<=0?"Fulfilled":"Donate"}
      </button>
    </div>
  `;

  otherNeedsDiv.innerHTML="";
  needs.slice(1,5).forEach(n=>{
    const div=document.createElement("div");
    div.className="need-card";
    div.innerHTML=`
      <img src="${n.image_url}" alt="${n.name}">
      <div class="overlay">
        <span>${n.name} — $${n.amount_needed}</span>
        <button ${n.amount_needed<=0?"disabled":""} onclick="openDonation(${n.id}, '${n.name}', ${n.amount_needed})">
          ${n.amount_needed<=0?"Fulfilled":"Donate"}
        </button>
      </div>
    `;
    otherNeedsDiv.appendChild(div);
  });
}

function openDonation(id,name,amountLeft){
  if(amountLeft<=0) return alert("This need is already fulfilled!");
  currentNeed={id,name,amountLeft};
  donationTitle.textContent=`Donate to "${name}"`;
  customAmount.value="";
  donationModal.classList.add("active");
}

function setAmount(val){ customAmount.value=val; }

function confirmDonation(){
  const amount = parseFloat(customAmount.value);
  if(isNaN(amount)||amount<=0) return alert("Enter valid amount");
  if(amount>currentNeed.amountLeft) return alert("Cannot donate more than needed");

  basket.push({id: currentNeed.id, name: currentNeed.name, amount});
  updateBasketUI();
  donationModal.classList.remove("active");
}

function updateBasketUI(){
  basketList.innerHTML="";
  let subtotal=0;
  basket.forEach(item=>{
    const div=document.createElement("div");
    div.innerHTML=`<span>${item.name}</span><span>$${item.amount}</span>`;
    basketList.appendChild(div);
    subtotal+=item.amount;
  });
  basketSubtotal.textContent=`Subtotal: $${subtotal}`;
}

function openBasket(){ basketModal.classList.add("active"); }
function closeBasket(){ basketModal.classList.remove("active"); }

async function checkoutBasket(){
  for(let item of basket){
    await fetch(`http://localhost:5000/api/needs/${item.id}/donate`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({amount: item.amount})
    });
  }
  basket=[];
  updateBasketUI();
  basketModal.classList.remove("active");
  loadNeeds(); // refresh the UI
}

function logout(){ localStorage.removeItem("user"); window.location.href="login.html"; }

loadNeeds();
</script>
</body>
</html>
