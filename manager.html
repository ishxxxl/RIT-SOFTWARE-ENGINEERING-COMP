<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manager Dashboard</title>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: url("Background.jpg") no-repeat center center fixed;
  background-size: cover;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}
header {
  background: rgba(255,255,255,0.9);
  padding: 15px 30px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
}
header img {
  height: 50px;
  width: auto;
}
header h1 {
  font-size: 22px;
  color: #007f5f;
  font-weight: 600;
  margin: 0;
  flex-grow: 1;
  text-align: center;
}
#logoutBtn {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
}
#logoutBtn:hover {
  background: #ff6666;
  transform: translateY(-1px);
}
.container {
  background: rgba(255,255,255,0.9);
  margin-top: 40px;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 900px;
  margin-bottom: 30px;
}
h2 { text-align: center; color: #007f5f; margin-bottom: 20px; }
form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
input, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 200px; }
button { background: linear-gradient(135deg,#00a86b,#007f5f); color:white; border:none; padding:10px 20px; cursor:pointer; }
button:hover { background: linear-gradient(135deg,#00b874,#009e63); transform: translateY(-2px); }
table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom:20px; }
th, td { padding: 12px; border-bottom: 1px solid #ccc; }
th { background: #00a86b; color: white; }
td button { padding: 6px 10px; margin:0 3px; font-size:14px; }
#noNeeds, #noRequests { text-align: center; color: gray; margin-top:20px; font-style: italic; }
footer { margin-top:auto; text-align:center; padding:10px; color:white; }
</style>
</head>
<body>
<header>
  <img src="Logo.jpg" alt="NeedsConnect Logo">
  <h1>U-Fund Manager Dashboard</h1>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">
  <h2>Manage Needs</h2>
  <form id="needForm">
    <input type="text" id="needName" placeholder="Need Name" required>
    <input type="text" id="needDesc" placeholder="Description" required>
    <select id="needCategory" required>
      <option value="">Category</option>
      <option value="Education">Education</option>
      <option value="Health">Health</option>
      <option value="Food">Food</option>
      <option value="Other">Other</option>
    </select>
    <input type="number" id="needAmount" placeholder="Amount (AED)" required>
    <button type="submit">Add Need</button>
  </form>

  <table id="needsTable">
    <thead>
      <tr><th>Name</th><th>Description</th><th>Category</th><th>Amount</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="noNeeds">No needs added yet.</p>
</div>

<div class="container">
  <h2>User Requests</h2>
  <table id="requestsTable">
    <thead>
      <tr><th>User</th><th>Need</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="noRequests">No requests available.</p>
</div>

<footer>Â© 2025 NeedsConnect | Manager Portal</footer>

<script>
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

window.onload = async function() {
  const loggedUser = localStorage.getItem("user");
  if (loggedUser !== "admin") {
    alert("Access denied. Only manager (admin) can view this page.");
    window.location.href = "login.html";
    return;
  }

  const API_BASE = "http://localhost:5000/api";
  const needsTableBody = document.querySelector("#needsTable tbody");
  const noNeedsMsg = document.getElementById("noNeeds");
  const needForm = document.getElementById("needForm");
  const requestsTableBody = document.querySelector("#requestsTable tbody");
  const noRequestsMsg = document.getElementById("noRequests");

  // --- Display Needs ---
  async function loadNeeds() {
    const res = await fetch(`${API_BASE}/needs`);
    const needs = await res.json();
    needsTableBody.innerHTML = "";
    if (needs.length === 0) {
      noNeedsMsg.style.display = "block";
      return;
    }
    noNeedsMsg.style.display = "none";
    needs.forEach(n => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${n.name}</td>
        <td>${n.description}</td>
        <td>${n.category}</td>
        <td>${n.amount_needed}</td>
        <td><button onclick="deleteNeed(${n.id})">Remove</button></td>`;
      needsTableBody.appendChild(row);
    });
  }

  // --- Add Need ---
  needForm.addEventListener("submit", async e => {
    e.preventDefault();
    const newNeed = {
      name: needForm.needName.value,
      desc: needForm.needDesc.value,
      category: needForm.needCategory.value,
      amount: needForm.needAmount.value
    };

    await fetch(`${API_BASE}/needs`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newNeed)
    });
    needForm.reset();
    loadNeeds();
  });

  // --- Delete Need ---
  window.deleteNeed = async function(id) {
    if (confirm("Remove this need?")) {
      await fetch(`${API_BASE}/needs/${id}`, { method: "DELETE" });
      loadNeeds();
    }
  };

  // --- Load Requests ---
  async function loadRequests() {
    const res = await fetch(`${API_BASE}/requests`);
    const requests = await res.json();
    requestsTableBody.innerHTML = "";
    if (requests.length === 0) {
      noRequestsMsg.style.display = "block";
      return;
    }
    noRequestsMsg.style.display = "none";
    requests.forEach(r => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.requestUser}</td>
        <td>${r.name}</td>
        <td>${r.amount}</td>
        <td>${r.status}</td>
        <td>
          <button onclick="handleRequest(${r.id}, 'Accepted')">Accept</button>
          <button onclick="handleRequest(${r.id}, 'Declined')">Decline</button>
        </td>`;
      requestsTableBody.appendChild(row);
    });
  }

  // --- Handle Request ---
  window.handleRequest = async function(id, status) {
    await fetch(`${API_BASE}/requests/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
    loadRequests();
    loadNeeds(); // refresh if new request accepted
  };

  loadNeeds();
  loadRequests();
};
</script>
</body>
</html>
